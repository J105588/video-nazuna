<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>試験公開_動画公開ページ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
<style>
    :root {
        --background-color: #0a0a0a; --text-color: #e0e0e0;
        --accent-gold: #d4af37; --card-background: #181818;
        --border-color: rgba(212, 175, 55, 0.3); --curtain-color: #4a0e0e;
        --font-serif: 'Noto Serif JP', serif; --font-sans: 'Noto Sans JP', sans-serif;
    }
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&family=Noto+Serif+JP:wght@400;700&display=swap');
    body {
        margin: 0; padding: 20px; font-family: var(--font-sans);
        background-color: var(--background-color); color: var(--text-color);
        display: flex; justify-content: center; align-items: center;
        min-height: 100vh; box-sizing: border-box; overflow: hidden;
    }
    .page-container {
        position: relative; max-width: 720px; width: 100%;
    }
    .page-state {
        width: 100%; padding: 30px; box-sizing: border-box; background: var(--card-background);
        border: 1px solid var(--border-color); border-radius: 8px;
        box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
        opacity: 1;
        transition: opacity 1.5s ease-out;
    }
    .page-state.hidden { opacity: 0; pointer-events: none; position: absolute; top: 0; left: 0; }
    h1 {
        text-align: center; font-family: var(--font-serif); font-size: 28px;
        margin-bottom: 25px; color: #fff;
        text-shadow: 0 0 10px var(--accent-gold), 0 0 2px #fff;
    }
    .video-wrapper { position: relative; width: 100%; margin-bottom: 30px; background: #000; border-radius: 8px;}
    video { width: 100%; display: block; border-radius: 8px; }
    .info { border-top: 1px solid var(--border-color); padding-top: 25px;}
    .info h2 { font-family: var(--font-serif); font-size: 22px; margin-top: 0; color: var(--accent-gold); }
    .info p { font-size: 14px; line-height: 1.7; color: #ccc; }
    .info p.copyright { font-size: 12px; color: #777; margin-top: 25px; text-align: center; }
    #secret-trigger { color: #777; cursor: pointer; user-select: none; display: inline-block; }
    #secret-trigger:hover { color: var(--accent-gold); }

    /* Weathered State */
    #weathered-state { animation: fadeIn 1s forwards; }
    #weathered-state.weathered-effect { animation: shake 25s infinite linear; }
    #weathered-state h1 { text-shadow: 0 0 4px #ff7752; color: #bbb; filter: blur(0.5px); }
    .interaction-area {
        min-height: 360px; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;
        border: 1px dashed var(--border-color); border-radius: 8px; margin-bottom: 30px; padding: 20px;
    }
    #qr-code-container { display: none; }
    #qr-code-container p { font-size: 0.9em; }
    #connection-text { font-size: 1.5rem; letter-spacing: 2px; }
    @keyframes shake {
        0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-1px); } 20%, 40%, 60%, 80% { transform: translateX(1px); }
    }

    /* Chat UI */
    #chat-ui { display: none; width: 100%; height: 100%; flex-direction: column; }
    #chat-messages {
        flex-grow: 1; width: 100%; overflow-y: auto; padding: 10px;
        border-bottom: 1px solid var(--border-color); margin-bottom: 10px;
        display: flex; flex-direction: column-reverse;
    }
    .message-container { display: flex; flex-direction: column; }
    .message {
        padding: 8px 12px; border-radius: 12px; margin-bottom: 8px;
        max-width: 80%; word-wrap: break-word; font-size: 14px;
    }
    .message.mine { background-color: var(--accent-gold); color: #000; align-self: flex-end; }
    .message.others { background-color: #333; align-self: flex-start; }
    .message.system { background: none; border: 1px solid var(--border-color); font-style: italic; color: #999; align-self: center; font-size: 12px; }
    #chat-form { display: flex; width: 100%; }
    #chat-input { flex-grow: 1; background: #222; border: 1px solid #444; border-radius: 5px; color: #eee; padding: 10px; }
    #chat-send { background: var(--accent-gold); color: #000; border: none; padding: 10px 15px; margin-left: 10px; border-radius: 5px; cursor: pointer; }

    /* Restored State */
    #restored-state {
        border: 2px solid var(--accent-gold); box-shadow: 0 0 40px var(--accent-gold);
        animation: restore-anim 3s forwards;
    }
    #restored-state h1 { text-shadow: 0 0 15px #fff, 0 0 8px var(--accent-gold); }
    @keyframes restore-anim { from { filter: blur(5px) grayscale(1); } to { filter: blur(0) grayscale(0); } }
    .restored-message { min-height: 360px; display: flex; justify-content: center; align-items: center; font-size: 1.2em; }

    /* Curtain */
    .curtain { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; z-index: 99; pointer-events: none; }
    .curtain-panel { width: 50%; height: 100%; background-color: var(--curtain-color); transition: transform 1.5s cubic-bezier(0.86, 0, 0.07, 1); }
    .curtain-panel.left { transform: translateX(-100%); }
    .curtain-panel.right { transform: translateX(100%); }
    .curtain.closed .curtain-panel { transform: translateX(0); }
</style>
</head>
<body>

<div class="page-container">
    <!-- State 1: Normal Page -->
    <div id="normal-state" class="page-state">
        <h1>動画公開ページ</h1>
        <div class="video-wrapper">
            <video controls poster="https://storage.googleapis.com/gemini-prod/images/55688941-86a3-455c-91d1-811122a61b8f">
                <source src="https://storage.googleapis.com/gtv-videos-bucket/sample/ForBiggerFun.mp4" type="video/mp4">
            </video>
        </div>
        <div class="info">
            <h2>試験公開_アスノヨゾラ哨戒班</h2>
            <p>これは試験公開動画です。<br>はじめにサムネイル画像が表示され、再生ボタンを押すと動画がスタートします。</p>
            <p class="copyright">© 2025 NAZUNA ENGEKI<span id="secret-trigger">5</span></p>
        </div>
    </div>

    <!-- State 2: Weathered Page -->
    <div id="weathered-state" class="page-state hidden">
        <h1>...接続を待機しています...</h1>
        <div class="interaction-area">
            <p id="connection-text">サーバーに接続中...</p>
            <div id="qr-code-container">
                <p>接続が確立しました。残りの方は、このQRコードを読み取ってください。</p>
                <canvas id="qr-code"></canvas>
            </div>
            <div id="chat-ui">
                <div id="chat-messages"></div>
                <form id="chat-form" action="javascript:void(0);">
                    <input type="text" id="chat-input" placeholder="メッセージを入力..." autocomplete="off">
                    <button type="submit" id="chat-send">送信</button>
                </form>
            </div>
        </div>
        <div class="info">
            <h2>舞台の残響</h2>
            <p>声が、聞こえる...。互いに位置を伝え合い、仲間を探さなければ...</p>
        </div>
    </div>

    <!-- State 3: Restored Page -->
    <div id="restored-state" class="page-state hidden">
        <h1>舞台は、再び光を取り戻した</h1>
        <div class="restored-message">
            <p>三つの魂が共鳴し、奇跡が起きる。まもなく、本当の幕が上がる...</p>
        </div>
    </div>
</div>

<!-- Curtain -->
<div id="curtain" class="curtain">
    <div class="curtain-panel left"></div>
    <div class="curtain-panel right"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    //
    // --- STEP3で取得したあなたのGASウェブアプリURLに書き換えてください ---
    //
    const GAS_URL = 'ここにあなたのGASウェブアプリのURLを貼り付けてください';

    // --- DOM Elements ---
    const states = {
        normal: document.getElementById('normal-state'),
        weathered: document.getElementById('weathered-state'),
        restored: document.getElementById('restored-state'),
    };
    const trigger = document.getElementById('secret-trigger');
    const curtain = document.getElementById('curtain');
    const connectionText = document.getElementById('connection-text');
    const qrContainer = document.getElementById('qr-code-container');
    const qrCanvas = document.getElementById('qr-code');
    const chatUI = document.getElementById('chat-ui');
    const chatMessages = document.getElementById('chat-messages');
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');
    const chatSend = document.getElementById('chat-send');
    
    // --- Game State ---
    let clickCount = 0;
    const requiredClicks = 5;
    let gameState = {
        sessionId: `sid_${new Date().getTime()}_${Math.random()}`,
        roomId: null,
        status: 'initial', // initial -> connecting -> waiting -> chatting -> ready -> finished
        isLeader: false,
        lastTimestamp: null,
        statusInterval: null,
        chatInterval: null,
    };

    // --- State Machine ---
    function switchState(newState) {
        Object.values(states).forEach(s => s.classList.add('hidden'));
        if (states[newState]) {
            states[newState].classList.remove('hidden');
        }
    }

    // --- Event Listeners ---
    trigger.addEventListener('click', () => {
        clickCount++;
        trigger.textContent = 5 - clickCount;
        if (clickCount >= requiredClicks) {
            trigger.textContent = "0";
            startWeatheredState();
        }
    });

    chatForm.addEventListener('submit', (e) => {
        e.preventDefault();
        sendMessage();
    });

    // --- Core Logic ---
    function startWeatheredState() {
        if (gameState.status !== 'initial') return;
        gameState.status = 'connecting';

        // 5を非表示にして、ページを切り替え
        trigger.style.display = 'none';
        switchState('weathered');
        states.weathered.classList.add('weathered-effect');

        const urlParams = new URLSearchParams(window.location.search);
        const roomIdFromUrl = urlParams.get('roomId');

        let action, params;
        if (roomIdFromUrl) {
            action = 'joinSession';
            params = { action, roomId: roomIdFromUrl, sessionId: gameState.sessionId };
        } else {
            action = 'startSession';
            params = { action, sessionId: gameState.sessionId };
        }
        
        callGas(params);
        gameState.statusInterval = setInterval(checkStatus, 5000); // 5秒ごとに状態確認
    }

    function checkStatus() {
        if (!gameState.roomId || gameState.status === 'ready' || gameState.status === 'finished') {
            clearInterval(gameState.statusInterval);
            return;
        }
        callGas({ action: 'checkStatus', roomId: gameState.roomId });
    }

    function handleGasResponse(data) {
        if (data.status === 'error') {
            console.error('GAS Error:', data.message);
            connectionText.textContent = "エラーが発生しました。リロードしてください。";
            clearIntervals();
            return;
        }

        gameState.roomId = data.roomId || gameState.roomId;
        gameState.isLeader = data.isLeader || false;
        const users = data.users || 0;

        if (gameState.status !== 'chatting' && users >= 2 && data.status === 'waiting') {
            // 2人揃ったらチャット開始
            gameState.status = 'chatting';
            showChatUI();
        }
        
        if (data.status === 'waiting') {
            connectionText.textContent = `${users} / 3 人が接続中...`;
            if (gameState.isLeader && !qrCanvas.qrious) {
                showQrCode();
            }
        } else if (data.status === 'ready' && gameState.status !== 'ready') {
            gameState.status = 'ready';
            startRestoration();
        }
    }

    function showQrCode() {
        connectionText.style.display = 'none';
        qrContainer.style.display = 'block';
        const urlToEncode = `${window.location.origin}${window.location.pathname}?roomId=${gameState.roomId}`;
        new QRious({ element: qrCanvas, value: urlToEncode, size: 200, padding: 10 });
    }
    
    function showChatUI() {
        connectionText.style.display = 'none';
        qrContainer.style.display = 'none'; // QRも隠す
        chatUI.style.display = 'flex';
        // チャットポーリング開始
        gameState.chatInterval = setInterval(getMessages, 2000);
    }

    function sendMessage() {
        const message = chatInput.value.trim();
        if (!message || !gameState.roomId) return;

        chatInput.value = '';
        chatInput.disabled = true;
        chatSend.disabled = true;

        const params = { action: 'sendMessage', roomId: gameState.roomId, sessionId: gameState.sessionId, message };
        callGas(params, 'POST').finally(() => {
            chatInput.disabled = false;
            chatSend.disabled = false;
            chatInput.focus();
        });
    }

    function getMessages() {
        if (!gameState.roomId) return;
        const params = { action: 'getMessages', roomId: gameState.roomId, lastTimestamp: gameState.lastTimestamp };
        callGas(params).then(data => {
            if (data && data.messages && data.messages.length > 0) {
                data.messages.forEach(addMessageToDOM);
                gameState.lastTimestamp = data.messages[data.messages.length - 1].timestamp;
            }
        });
    }

    function addMessageToDOM(msg) {
        const msgContainer = document.createElement('div');
        msgContainer.className = 'message-container';

        const msgDiv = document.createElement('div');
        msgDiv.className = 'message';
        msgDiv.textContent = msg.message;

        if (msg.sessionId === gameState.sessionId) {
            msgDiv.classList.add('mine');
        } else if (msg.sessionId === 'SYSTEM') {
             msgDiv.classList.add('system');
        } else {
            msgDiv.classList.add('others');
        }
        
        msgContainer.appendChild(msgDiv);
        chatMessages.prepend(msgContainer);
    }

    function startRestoration() {
        clearIntervals();
        switchState('restored');
        setTimeout(() => {
            curtain.classList.add('closed');
            setTimeout(() => {
                gameState.status = 'finished';
                window.location.href = 'index.html'; // ここを実際の次のページ名に変更
            }, 1600);
        }, 4000);
    }

    function clearIntervals() {
        if (gameState.statusInterval) clearInterval(gameState.statusInterval);
        if (gameState.chatInterval) clearInterval(gameState.chatInterval);
    }

    async function callGas(params, method = 'GET') {
        try {
            let response;
            if (method === 'POST') {
                response = await fetch(GAS_URL, {
                    method: 'POST',
                    mode: 'no-cors', // no-cors is often needed for simple POST to GAS
                    cache: 'no-cache',
                    redirect: 'follow',
                    body: JSON.stringify(params)
                });
                // For 'no-cors' POST, we don't get a readable response, so we just assume it worked.
                return {};
            } else {
                const url = `${GAS_URL}?${new URLSearchParams(params).toString()}`;
                response = await fetch(url, { method: 'GET', redirect: 'follow' });
            }

            if (!response.ok && method !== 'POST') throw new Error(`HTTP error! status: ${response.status}`);
            
            const data = await response.json();
            handleGasResponse(data);
            return data;

        } catch (error) {
            console.error('GAS call failed:', error);
        }
    }
    
    // 初期URLパラメータをクリア
    if (window.location.search.includes('roomId')) {
        history.replaceState(null, '', window.location.pathname);
    }
});
</script>

</body>
</html>